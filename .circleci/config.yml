version: 2.1

jobs:
  test:
    docker:
      - image: circleci/python:3.7
      - image: circleci/postgres:12-ram
        environment:
          POSTGRES_DB: vis_test
          POSTGRES_USER: vis
          POSTGRES_PASSWORD: vis
    working_directory: ~/ghostdb
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements/ci.txt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Install Requirements
          command: |
            python -m venv ../venv
            . ../venv/bin/activate
            pip install -r requirements/ci.txt
      - save_cache:
          paths:
            - ../venv
          key: v1-dependencies-{{ checksum "requirements/ci.txt" }}
      - run:
          name: Waiting for Postgres to be ready
          command: |
            for i in `seq 1 10`;
            do
              nc -z localhost 5432 && echo Success && exit 0
              echo -n .
              sleep 1
            done
            echo Failed waiting for Postgres && exit 1
      - run:
          name: Python Version
          command: python -V
      - run:
          name: "PostgreSQL: configure extensions"
          command: |
            sudo apt install -y postgresql-client
            psql -h localhost -U vis -c "CREATE EXTENSION IF NOT EXISTS ltree;" vis_test
          environment:
            PGPASSWORD: vis
      - run:
          name: Tests
          when: always
          environment:
            PYTHONPATH: ..
            GHOSTDB_DB_DSN: postgresql://vis:vis@localhost:5432/vis_test
          command: |
            . ../venv/bin/activate
            python -m pytest \
              --pylama \
              --ignore=./ghostdb/alembic \
              --junitxml=../tests_artifacts/junit.xml \
              --cov=. --cov-report=xml:../tests_artifacts/coverage.xml --cov-report=html:../tests_artifacts/coverage/ \
              ghostdb/
      - store_test_results:
          path: ../tests_artifacts/
          destination: tests_artifacts
      - store_artifacts:
          path: ../tests_artifacts/
          destination: tests_artifacts

  build-pkg:
    docker:
      - image: circleci/python:3.7
    working_directory: ~/ghostdb
    steps:
      - checkout
      - run:
          name: Python Version
          command: python -V
      - run:
          name: Configure PyPi
          command: |
            echo -e "[distutils]" >> ~/.pypirc
            echo -e "index-servers = vis" >> ~/.pypirc
            echo -e "[vis]" >> ~/.pypirc
            echo -e "repository = $VIS_PYPI_URL" >> ~/.pypirc
            echo -e "username = ghostdb" >> ~/.pypirc
            echo -e "password = $GHOSTDB_PYPI_PASSWORD" >> ~/.pypirc
      - run:
          name: Make and Upload Package
          command: python setup.py egg_info -b dev`date "+%Y%m%d%H%M"` sdist upload -r vis


orbs:
  jira: circleci/jira@1.0.5

workflows:
  version: 2.1

  ghostdb:
    jobs:
      - test:
          post-steps:
            - jira/notify
      - build-pkg:
          filters:
            branches:
              only:
                - master
          requires:
            - test
